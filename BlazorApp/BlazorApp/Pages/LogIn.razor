@page "/LogIn"
@using BlazorApp.Models;
@using Microsoft.Extensions.Logging;
@using System.Security.Cryptography;
@using System.Text;
@using DataLibrary;
@using Microsoft.Extensions.Configuration;
@inject Identification identification
@inject IDataAccess _data
@inject IConfiguration _config
@inject NavigationManager NavManager

<div>
    <p>Enter your login :</p>
    <input type="text" @bind="@identification.Login" @oninput="OnInputLogin"/>
    <p>Enter your password</p>
    <input type="password" @bind="@identification.Password" @oninput="OnInputPass"/>
</div>
@if(identification.Game != null)
{
    <p>identification.Game.Ia.GameBoard.Ships.Count</p>
}
<link href="/css/LogIn.css" rel="stylesheet" />

<div class="container">
		<div class="row">
			<div class="col-sm-9 col-md-7 col-lg-5 mx-auto">
				<div class="errorContainer">
				</div>
				<div class="card card-signin my-5">
					<div class="card-body">
						<h5 class="card-title text-center">Log in</h5>
						<EditForm Model="@identification" OnValidSubmit="@HandleValidSubmit">
							<DataAnnotationsValidator />
							<ValidationSummary />
							<div class="alert alert-danger alert-dismissible fade @loginErrorState" role="alert">
								<strong>Incorrect password</strong>
							</div>
							<div class="form-label-group">
								<InputText id="inputLogin" class="form-control" @bind-Value="identification.Login" />
								<label for="inputLogin">Login</label>
							</div>
							<div class="form-label-group">
								<InputText type="password" id="inputPassword" class="form-control" placeholder="Mot de passe" @bind-Value="identification.Password" />
								<label for="inputPassword">Mot de passe</label>
							</div>
							<button class="btn btn-lg btn-primary btn-block text-uppercase" type="submit">Connect</button>
						</EditForm>
					</div>
				</div>
			</div>
		</div>
	</div>

@code {
	List<UserModel> user;
	bool CorrectPassword;
	string loginErrorState = "fade";
	string password = "";

	private async Task GetUser()
	{
		string sql = "select * from user where login like'"+identification.Login+"'";

		user = await _data.LoadData<UserModel, dynamic>(sql, new { }, _config.GetConnectionString("default"));
	}

	private async Task PasswordHash()
	{
		using (SHA256 sha256Hash = SHA256.Create())
		{
			byte[] sourceBytes = Encoding.UTF8.GetBytes(identification.Password);
			byte[] hashBytes = sha256Hash.ComputeHash(sourceBytes);
			string hash = BitConverter.ToString(hashBytes).Replace("-", String.Empty);
			password = hash;
		}
	}

	private async Task CheckPassword()
	{
		CorrectPassword = false;
		await PasswordHash();

		if(user[0].Password == password)
		{
			CorrectPassword = true;
		}
		else
		{
			loginErrorState = "show";
		}
	}

	private async Task HandleValidSubmit()
	{
		await GetUser();
		await CheckPassword();

		if(CorrectPassword == true)
		{
			identification.LogIn(user[0].Login, user[0].IsAdmin, user[0].IsMale);
		}
		
    }

	protected override Task OnAfterRenderAsync(bool firstRender)
    {
        if(identification.Connected){
			NavManager.NavigateTo("/", forceLoad: true);
		}
        return base.OnAfterRenderAsync(firstRender);
    }

}